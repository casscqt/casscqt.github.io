<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> iOS Label最后一行中间截图显示缩略符 · Cass的博客</title><meta name="description" content="iOS Label最后一行中间截图显示缩略符 - Cass"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://casscqt.github.io/atom.xml" title="Cass的博客"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">iOS Label最后一行中间截图显示缩略符</h1><div class="post-info">Oct 30, 2016</div><div class="post-content"><h2 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h2><p>继上次本文本有行间距，当时交互有另一个需求，需要在文本最后一行省略符号放中间，只省略到最后一行的中间。如下图需求。Label的自带LineBreakMode不支持如下的设置。便要自己处理，经过网上的资料参考和同事J学习探讨，这里记录一下解决方案与过程。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/132693-51916dc2ba856926.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="图1.png"></p>
<h2 id="二、分析"><a href="#二、分析" class="headerlink" title="二、分析"></a>二、分析</h2><p>文本只需要最后一行进行处理，因此取得能取得文本最后一行，并进行计算，当最后一行的文本超过中间，则截取字符到中间，并增加一个“…”字符串。</p>
<h2 id="三、解决方案"><a href="#三、解决方案" class="headerlink" title="三、解决方案"></a>三、解决方案</h2><p>核心方法为网上大神所写获得Label每行文本字符串数组的方法，对拿到的最后一行进行处理。处理方式还是要利用获取每行文本的方法，传入一个显示label宽度的一半label。这时计算出来的最后一行的点点点省略号，误差就在一个字符。<br><a id="more"></a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">//获得Label每行的文本字符串数组</div><div class="line">- (NSArray *)getLinesArrayOfStringInLabel:(UILabel *)label&#123;</div><div class="line">    NSString *text = [label text];</div><div class="line">    UIFont *font = [label font];</div><div class="line">    CGRect rect = [label bounds];</div><div class="line"></div><div class="line">    CTFontRef myFont = CTFontCreateWithName((__bridge CFStringRef)([font fontName]), [font pointSize], NULL);</div><div class="line">    NSMutableAttributedString *attStr = [[NSMutableAttributedString alloc] initWithString:text];</div><div class="line">    [attStr addAttribute:(NSString *)kCTFontAttributeName value:(__bridge id)myFont range:NSMakeRange(0, attStr.length)];</div><div class="line">    CTFramesetterRef frameSetter = CTFramesetterCreateWithAttributedString((__bridge CFAttributedStringRef)attStr);</div><div class="line">    CGMutablePathRef path = CGPathCreateMutable();</div><div class="line">    CGPathAddRect(path, NULL, CGRectMake(0,0,rect.size.width,100000));</div><div class="line">    CTFrameRef frame = CTFramesetterCreateFrame(frameSetter, CFRangeMake(0, 0), path, NULL);</div><div class="line">    NSArray *lines = (__bridge NSArray *)CTFrameGetLines(frame);</div><div class="line">    NSMutableArray *linesArray = [[NSMutableArray alloc]init];</div><div class="line">    for (id line in lines)&#123;</div><div class="line">        CTLineRef lineRef = (__bridge CTLineRef )line;</div><div class="line">        CFRange lineRange = CTLineGetStringRange(lineRef);</div><div class="line">        NSRange range = NSMakeRange(lineRange.location, lineRange.length);</div><div class="line">        NSString *lineString = [text substringWithRange:range];</div><div class="line">        [linesArray addObject:lineString];</div><div class="line">    &#125;</div><div class="line">    return (NSArray *)linesArray;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再利用此方法处理最后一行文本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">//Label每行文本数组</div><div class="line"> NSArray *separatedLines = [NSString getSeparatedLinesFromLabel:self.label];</div><div class="line">    </div><div class="line">    NSMutableString *limitedText = [NSMutableString string];</div><div class="line">    if ( separatedLines.count &gt;= self.label.numberOfLines ) &#123;//当超过最大行数</div><div class="line">        for (int i = 0 ; i &lt; self.label.numberOfLines; i++) &#123;</div><div class="line">            if ( i == self.label.numberOfLines - 1) &#123;//处理最后一行文本</div><div class="line">                UILabel *lastLineLabel = [[UILabel alloc]initWithFrame:CGRectMake(0, 0, self.label.frame.size.width/2, MAXFLOAT)];</div><div class="line">                lastLineLabel.text = separatedLines[self.label.numberOfLines - 1];</div><div class="line">                NSArray *subSeparatedLines = [NSString getSeparatedLinesFromLabel:lastLineLabel];</div><div class="line">                NSString *lastLineText = [subSeparatedLines firstObject];</div><div class="line">                NSInteger lastLineTextCount = lastLineText.length;</div><div class="line">                [limitedText appendString:[NSString stringWithFormat:@&quot;%@...&quot;,[lastLineText substringToIndex:lastLineTextCount]]];</div><div class="line">            &#125;else&#123;//非最后一行，则将文本进行存储</div><div class="line">                [limitedText appendString:separatedLines[i]];</div><div class="line">            &#125;</div><div class="line">        &#125;  </div><div class="line">    &#125;else&#123;</div><div class="line">        [limitedText appendString:self.text];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">self.label.text = limitedText;</div></pre></td></tr></table></figure>
<h2 id="四、封装与使用"><a href="#四、封装与使用" class="headerlink" title="四、封装与使用"></a>四、封装与使用</h2><p>写一个Label分类，对需要进行最后一行中间省略号的Label调用一下 setLineBreakByTruncatingLastLineMiddle 方法，同时需要设置一下最大行数numberOfLines。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">#import &quot;UILabel+QT.h&quot;</div><div class="line">#import &lt;CoreText/CoreText.h&gt;</div><div class="line"></div><div class="line">@implementation UILabel (QT)</div><div class="line"></div><div class="line">- (void)setLineBreakByTruncatingLastLineMiddle&#123;</div><div class="line"></div><div class="line">    if ( self.numberOfLines &lt;= 0 ) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    NSArray *separatedLines = [self getSeparatedLinesArray];</div><div class="line">    </div><div class="line">    NSMutableString *limitedText = [NSMutableString string];</div><div class="line">    if ( separatedLines.count &gt;= self.numberOfLines ) &#123;</div><div class="line">        </div><div class="line">        for (int i = 0 ; i &lt; self.numberOfLines; i++) &#123;</div><div class="line">            if ( i == self.numberOfLines - 1) &#123;</div><div class="line">                UILabel *lastLineLabel = [[UILabel alloc]initWithFrame:CGRectMake(0, 0, self.frame.size.width/2, MAXFLOAT)];</div><div class="line">                lastLineLabel.text = separatedLines[self.numberOfLines - 1];</div><div class="line">                </div><div class="line">                NSArray *subSeparatedLines = [lastLineLabel getSeparatedLinesArray];</div><div class="line">                NSString *lastLineText = [subSeparatedLines firstObject];</div><div class="line">                NSInteger lastLineTextCount = lastLineText.length;</div><div class="line">                [limitedText appendString:[NSString stringWithFormat:@&quot;%@...&quot;,[lastLineText substringToIndex:lastLineTextCount]]];</div><div class="line">            &#125;else&#123;</div><div class="line">                [limitedText appendString:separatedLines[i]];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        </div><div class="line">    &#125;else&#123;</div><div class="line">        [limitedText appendString:self.text];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    self.text = limitedText;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSArray *)getSeparatedLinesArray</div><div class="line">&#123;</div><div class="line">    NSString *text = [self text];</div><div class="line">    UIFont   *font = [self font];</div><div class="line">    CGRect    rect = [self frame];</div><div class="line">    </div><div class="line">    CTFontRef myFont = CTFontCreateWithName((__bridge CFStringRef)([font fontName]), [font pointSize], NULL);</div><div class="line">    NSMutableAttributedString *attStr = [[NSMutableAttributedString alloc] initWithString:text];</div><div class="line">    [attStr addAttribute:(NSString *)kCTFontAttributeName value:(__bridge id)myFont range:NSMakeRange(0, attStr.length)];</div><div class="line">    </div><div class="line">    CTFramesetterRef frameSetter = CTFramesetterCreateWithAttributedString((__bridge CFAttributedStringRef)attStr);</div><div class="line">    </div><div class="line">    CGMutablePathRef path = CGPathCreateMutable();</div><div class="line">    CGPathAddRect(path, NULL, CGRectMake(0,0,rect.size.width,100000));</div><div class="line">    </div><div class="line">    CTFrameRef frame = CTFramesetterCreateFrame(frameSetter, CFRangeMake(0, 0), path, NULL);</div><div class="line">    </div><div class="line">    NSArray *lines = (__bridge NSArray *)CTFrameGetLines(frame);</div><div class="line">    NSMutableArray *linesArray = [[NSMutableArray alloc]init];</div><div class="line">    </div><div class="line">    for (id line in lines)</div><div class="line">    &#123;</div><div class="line">        CTLineRef lineRef = (__bridge CTLineRef )line;</div><div class="line">        CFRange lineRange = CTLineGetStringRange(lineRef);</div><div class="line">        NSRange range = NSMakeRange(lineRange.location, lineRange.length);</div><div class="line">        </div><div class="line">        NSString *lineString = [text substringWithRange:range];</div><div class="line">        [linesArray addObject:lineString];</div><div class="line">    &#125;</div><div class="line">    return (NSArray *)linesArray;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<h2 id="五、思考"><a href="#五、思考" class="headerlink" title="五、思考"></a>五、思考</h2><blockquote>
<p>系统可以直接Label的lineBreakMode，如果可以给系统lineBreakMode增加一个枚举类型NSLineBreakByTruncatingLastLineMiddle，那在使用的时候，直接设置一下就好了是该多方便。不知道这个想法的可行性，需要学习了解看看。如果后续有这样的解决方案，再来补充。</p>
</blockquote>
<p>经过探讨，想给系统lineBreakMode增加一个枚举还是行不通的，毕竟系统的代码没有开源，其次，要是能修改也是自己能用。所以，遇到这种情况，可以写一个类方法，或者是给类增加一个属性，例如otherLineBreakMode，进行处理。</p>
<h2 id="六、参考资料"><a href="#六、参考资料" class="headerlink" title="六、参考资料"></a>六、参考资料</h2><p><a href="http://stackoverflow.com/questions/34867231/issue-get-lines-array-of-string-inn-label" target="_blank" rel="external">http://stackoverflow.com/questions/34867231/issue-get-lines-array-of-string-inn-label</a></p>
</div></article></div></main><footer><div class="paginator"><a href="/2016/11/19/iOS-验证码View的实现方案/" class="prev">PREV</a><a href="/2016/10/23/iOS中文行间距富文本高度与显示那些坑/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2017 <a href="https://casscqt.github.io">Cass</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>